<script type="text/javascript" src="javascript/post.js"></script>
<script type="text/javascript" src="javascript/comment.js"></script>
<script type="text/javascript">
	$(document).ready(function() {
		if($('#post_username').val() == '' && $.cookie('username') != null)
			$('#post_username').val($.cookie('username'));
		post = new Post();
		comment = new Comment();
		csrf = $('[name="_csrf"]').val();
		
		function refresh() {
			post.get(undefined, postsHandler);
		}
		
		function report(text) {
			$('#notice').html(text);
		}
		
		function postsHandler(data) {
			$('#posts').html('');
			if(data == undefined)
				return;
			$('#posts').html('<section>');
			for(i=0, len=data.length; i<len; ++i) {
				if(data[i] == undefined || data[i].username == undefined)
					continue;
				$('#posts').append('<article id="post_'+data[i].id+'" class="post">');
					$('#post_'+data[i].id).append('<header>');
						date = $.format.date(data[i].created_at, 'MM/dd/yyyy') + ' at ' + $.format.date(data[i].created_at, 'HH:mm:ss');
						$('#post_'+data[i].id).append('Written by '+data[i].username+' the <time pubdate datetime="'+data[i].created_at+'">'+date+'</time>');
					$('#post_'+data[i].id).append('</header>');
					$('#post_'+data[i].id).append('<p>'+data[i].text+'</p>');
					$('#post_'+data[i].id).append('<footer>');
						$('#post_'+data[i].id).append('<a class="deletePost">Delete</a>');
					$('#post_'+data[i].id).append('</footer>');
				$('#post_'+data[i].id).append('</article>');
			}
			$('#posts').append('</section>');
		}
		
		$('.deletePost').live('click', function(e) {
			e.preventDefault();
			item = $(this);
			id = item.parent().parent().find('.post').attr('id').replace('post_', '');
			post.destroy(id, csrf, report);
			refresh();
		});
		
		$('#new_post').live('click', function(e) {
			e.preventDefault();
			post.create($('#post_username').val(), $('#post_text').val(), csrf, report);
			refresh();
		});
		
		refresh();
		
	});
</script>

<div id="posts"></div>
<form>
	<%= csrf_tag %>
	<input type="text" id="post_username" placeholder="Username (leave blank to be anon)" /><br />
	<textarea id="post_text" placeholder="Text"></textarea><br />
	<input type="submit" id="new_post" value="Send" />
</form>
